<html>
   <head>
       <meta charset="UTF-8"/>
       <title>try try see</title>
       <link href="style.css" rel="stylesheet">
       <script src="phaser.min.js"></script>
       <script src="jquery-2.2.0.min.js"></script>
   </head>
   <body>
       <div class="container">
         <div class="gameview"id="tts"></div>
         <div class="question-block">
           <div class="question-text">
             我是題目，我也是題目，還是題目。我是題目，我也是題目，還是題目。我是題目，我也是題目，還是題目。我是題目，我也是題目，還是題目。我是題目，我也是題目，還是題目。我是題目，我也是題目，還是題目。我是題目，我也是題目，還是題目。
           </div>
         </div>
       </div>

       <script lang="javascript">



       //可調參數 start **************************************
       // var gameWidth = 1000;
       var gameHeight = 800;
       var gameWidth = Math.floor($(document).width() * 0.7 -5 );
       // var gameHeight = Math.floor($(document).height() - 5);

       //殭屍x軸出現位置範圍（寬度的百分比)
       var ZOMBIE_APPEARING_POSITISION_IN_X_PERCENTAGE_FROM = 0.2;
       var ZOMBIE_APPEARING_POSITISION_IN_X_PERCENTAGE_TO = 0.8;

       //殭屍一開始的大小
       var ZOMBIE_INIT_SCALE = 0.3;
       // 殭屍"往前走"放大比例速度
       var ZOMBIE_SCALE_INCREASING_RATE = 0.02;
       // 殭屍碰到player的放大倍數
       var ZOMBIE_MEET_PLAYER_SCALE = 2;


       // 可調參數 end ************************************




        // phaserCreate the game object itself
        var game = new Phaser.Game(
            gameWidth,    gameHeight,                   // 800 x 600 rebackgroundolution.
           Phaser.AUTO,                   // Allow Phaser to determine Canvas or WebGL
           "tts",                   // The HTML element ID we will connect Phaser to.
           {                               // Functions (callbacks) for Phaser to call in
               preload: phaserPreload,     // in different states of its execution
               create: phaserCreate,
               update: phaserUpdate,
               render: phaserRender
           }
        );

        function phaserPreload() {
          game.load.image('zombie', 'zombie.gif');
          //game.load.image('zombie', 'zombie2.jpg');
        }

        var zombieGroup;
        var ZOMBIE_APPEARING_POSITISION_IN_X_POINT_FROM;
        var ZOMBIE_APPEARING_POSITISION_IN_X_POINT_TO;
        var ZOMBIE_APPEARING_POSITISION_IN_X_POINT_CENTER;
        var isAllZombiePaused;
        var isDebug;
        var zombieWaitingForAnswer; // 被點到，或是碰到player的殭屍

        function phaserCreate() {
          game.physics.startSystem(Phaser.Physics.ARCADE);

          // pre-calculation
          ZOMBIE_APPEARING_POSITISION_IN_X_POINT_FROM = Math.floor(game.world.width * ZOMBIE_APPEARING_POSITISION_IN_X_PERCENTAGE_FROM);
          ZOMBIE_APPEARING_POSITISION_IN_X_POINT_TO = Math.floor(game.world.width * ZOMBIE_APPEARING_POSITISION_IN_X_PERCENTAGE_TO);
          ZOMBIE_APPEARING_POSITISION_IN_X_POINT_CENTER = (ZOMBIE_APPEARING_POSITISION_IN_X_POINT_TO - ZOMBIE_APPEARING_POSITISION_IN_X_POINT_FROM) /2;

          zombieGroup = game.add.group();
          zombieGroup.enableBody = true;
          zombieGroup.createMultiple(10, 'zombie');
          zombieGroup.setAll('anchor.x', 0);
          zombieGroup.setAll('anchor.y', 0);
          zombieGroup.setAll('outOfBoundsKill', true);

          isAllZombiePaused = false;
          isDebug = getUrlVars()['debug'] === "1";

          game.time.events.loop(Phaser.Timer.SECOND * 2, zombieRising, this);
          //zombieRising();
        }

        function zombieRising() {
          if(isAllZombiePaused) {
            return;
          }

          var zombie = zombieGroup.getFirstExists(false);
          if(zombie === null) {
            return;
          }
          // zombie appearing position x-axis
          var x  =  game.rnd.integerInRange(ZOMBIE_APPEARING_POSITISION_IN_X_POINT_FROM,
                                              ZOMBIE_APPEARING_POSITISION_IN_X_POINT_TO);
          zombie.reset(x, 15);
          zombie.scale.setTo(ZOMBIE_INIT_SCALE,ZOMBIE_INIT_SCALE);
          zombieGroup.sendToBack(zombie);
          zombie.body.velocity.y = 3;
          zombie.body.acceleration.y = 1.5;
          zombie.body.velocity.x = game.rnd.integerInRange(10, 25);
          zombie.body.acceleration.x = game.rnd.realInRange(3.0, 4.6);
          if(x >= ZOMBIE_APPEARING_POSITISION_IN_X_POINT_CENTER) { //出現位置靠右邊的往左走
            zombie.body.velocity.x = game.rnd.integerInRange(-10, -25);
            zombie.body.acceleration.x = game.rnd.realInRange(-3, -4.2);
          }
          zombie.inputEnabled = true;
          zombie.tint = 0xFFFFFF;
          zombie.events.onInputDown.add(zombieClick, this);
          zombie.events.onInputOver.add(zombieMouseHover, this);
          zombie.events.onInputOut.add(zombieMouseHoverOut, this);

          var ansTextArea = game.make.text(0,
                                            100,
                                            "System.out.println('_____');\nSystem.out.exit(1);",
                                            { font: "15px Arial",
                                              fill: "#40FF00",
                                              wordWrap: false,
                                              align: "left",
                                              backgroundColor: "#1C1C1C"
                                            });
          var ansTypeArea = game.make.text(0, 150,
                                          "HelloWorld",
                                          { font: "15px Arial",
                                            fill: "#F7FE2E",
                                            wordWrap: false,
                                            align: "center",
                                            backgroundColor: "#1C1C1C"
                                          });
          zombie.addChild(ansTextArea);
          zombie.addChild(ansTypeArea)
          zombie.ansTextArea = ansTextArea;
          zombie.ansTyeArea = ansTypeArea;

          if(isDebug) {
            console.log("live counting:" + zombieGroup.countLiving() + ", dead counting:" +zombieGroup.countDead());
          }
        }

        function pauseAllAliveZombies() {
          isAllZombiePaused = true;

          zombieGroup.forEachAlive(function(zombie_foo) {
            zombie_foo.body.enable = false;
          }, this);

        }

        function resumeAllPasuedZombies() {
          zombieGroup.forEachAlive(function(zombie_foo) {
            zombie_foo.body.enable = true;
          }, this);

          isAllZombiePaused = false;
        }

        function zombieMouseHover(zombieHoverOn, point) {
          zombieHoverOn.tint = 0xFE2E2E;
        }

        function zombieMouseHoverOut(zombieHoverThenOut, point) {
          zombieHoverThenOut.tint = 0xFFFFFF;
        }

        function zombieClick(clickedZombie, point) {
          if(isDebug) {
            console.log("zombie clicked at:" + zombieGroup.getIndex(clickedZombie));
          }



          if(isAllZombiePaused) {
            clickedZombie.parent.setChildIndex(clickedZombie, clickedZombie.zIndexBeforeClicked);

            if(isDebug) {
              console.log("zombie moved back to " + clickedZombie.z);
            }
            resumeAllPasuedZombies();
          } else {

            clickedZombie.zIndexBeforeClicked = clickedZombie.z;
            zombieGroup.bringToTop(clickedZombie);
            if(isDebug) {
              console.log("zombie was on " + clickedZombie.zIndexBeforeClicked + ", and moved to front at " + clickedZombie.z);
            }
            zombieWaitingForAnswer = clickedZombie;
            pauseAllAliveZombies();
          }


        }


        function phaserUpdate() {

          if(isAllZombiePaused === false) {
            zombieGroup.forEachAlive(function(zombie) {
              var newscale = zombie.y * ZOMBIE_SCALE_INCREASING_RATE;
              if(newscale >= ZOMBIE_INIT_SCALE) {
                zombie.scale.x = newscale;
                zombie.scale.y = newscale;
              }


              if(zombie.scale.x > ZOMBIE_MEET_PLAYER_SCALE) {
                // meet the player
                zombie.kill();
              }

            }, this);
          }
        }


        function phaserRender() {

          if(isDebug) {
            var foo = zombieGroup.getFirstAlive();
            if(foo !== undefined && foo !== null) {
              game.debug.bodyInfo(foo, 20, 32);
            }
          }
        }


        function getUrlVars(){
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }


       </script>
   </body>
</html>
